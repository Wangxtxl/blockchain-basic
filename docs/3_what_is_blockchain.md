# 区块链技术概述

### 概述

比特币诞生的几年后，人们开始意识到区块链技术本身的潜力，慢慢走出了自己的发展路线。
通常区块链被定义为一种去中心化的分布式账本技术，最初用来记录信息，使记录具备不可篡改性，因此不需要额外的第三方机构来证明记录的真实性。

随着以太坊的出现，还可以以去中心化的方式运行程序（智能合约），确保程序的运行不被干预、篡改，使区块链成为一个公共的计算平台。


##  什么是区块链(技术)

狭义上说区块链是一种区块通过 Hash 方式形成的链式结构，因为链的环环相扣，任何一个区块上的修改，破坏链结构，参考[这里](./how_bitcoin_work.md#使用工作量证明挖掘新区块)，使其具备易于验证、不可篡改的特性。

<details>
  <summary> 区块是区块链中的数据存储单元 </summary>
    <div>每一个区块中存储了一组交易信息，这些交易信息的哈希数据为作为默克尔树节点存储存储，每个区块同时存储前一个区块的哈希信息，因此区块就通过哈希信息链接起来，形成区块链。
  </div>
</details>


广义来讲区块链定义为一个共享的、不可篡改的账本，可用于记录网络中的交易和跟踪“资产”流转。
这里“资产”可以是任何有价的东西， 可以是货币、股票、土地、知识产权、品牌等，当他们在区块链网络上、公开透明的流转和交易是，可降低各方面的风险和成本。

在经济活动中，往往是依靠信息进行决策，信息的真实性、信息的传递速度都多业务决策至关重要，区块链是用于传递这些信息的理想之选，因为它可提供即时、共享和完全透明的信息，这些信息存储在不可篡改的账本上。

区块链包含 3 个关键元素：

1. 分布式账本技术
所有网络参与者都有权访问分布式账本及其不可篡改的交易记录。

2. 不可篡改的记录
在交易被记录到共享账本之后，任何参与者都不可以更改或篡改交易。

3. 智能合约


## 智能合约

2013 年，Vitalik 提出了以太坊，创造性引入智能合约，极大的丰富了区块链的执行程序能力。


<details>
  <summary> 智能合约 名称由来 </summary>
    <div> 智能合约是链上的程序，为什么叫智能合约呢？“合约”是取材自现实中的合约，是想强调链上的程序可以按协议规则执行，就像法律条款一样。“智能” 主要是强调不受干预的可自动执行。
  </div>
</details>


在以太坊提出之前，区块链上可进行交易的一般都是像比特币这样的加密货币，然后在交易的附言阶段附带上一些信息。而以太坊扩大了交易的边界，它让交易发生的同时可以执行一段代码。这也就意味着交易本身具备了逻辑，毕竟现实中的很多交易是有逻辑条件的，比如有的交易要分期付款，或者多方参与的借贷。像保险合同的执行也是有事前约定的条件，这些合约条件都没办法单纯地依靠比特币这样的转账记录来达成。而当交易可以附带一份代码的时候，情况就完全不同了，我们可以通过代码来写出这些合约的执行条件，在条件满足的时候才执行真正的交易。甚至，交易可以完全不产生货币转账，而是用代码来描述一份数字资产。总之，当区块链中可以存储代码和执行代码，给我们带来了无限想象空间。


## 代币（token）是什么

需要注意的是，由于区块链记录的是转账信息，自然就会出现一个转账物的概念。如果任意定义这个转账物，那么区块链和传统的存储技术也就没什么太大的区别。因此，大部分区块链都会定义一个通用的转账物，而其他的数字资产可以通过某种规则映射到这个通用转账物上。随着时间的推移，大家就开始使用代币（token）来表示这个通用转账物。
代币是区块链里的一个关键概念，但是考虑到一些特殊的情况，也有可能出现无币区块链。所以代币并不是区块链的必要属性。



### 区块是怎么产生的

每个区块由参与其中的计算机节点独立生成。由于是分布式网络，所以就会有不同的区块在同一时间被生产出来。区块链数据库中的区块通过哈希信息相连构成了一条基于哈希信息的历史链。不同的区块在同一时间产生，系统中就出现了多条历史链。区块链会提供一套算法来对每一条历史链进行打分，以此来留下分数更高的链，同时淘汰分数低的链。
随着时间的推移，区块链的每一个独立节点都在生产自己的区块，同时接收其他节点传递过来的区块。所以节点本地总是会有多条历史链。这时候，节点就需要在本地生产的区块和接收到的区块中进行选择，如果接收到的区块构成的历史链优于自己本地的，那么就会销毁自己刚刚生成的区块，然后以更优的历史链为基础，再生成新的区块并广播给网络中其他的节点。
由于区块生成一直在各个节点中不停地发生，所以从任何一个节点上得到的历史链都无法保证是最优的。但是由于区块链总是把新的区块不停地加到旧的历史链上，每一次添加都会增加这条链的分数。这也就意味着，随着时间的推移，某一个区块后边总是会跟上很多新的区块，当它被广播出去之后，该区块也更可能被更多的机器所识别，并以此为基础构建本地的新链，所以虽然这个区块后边跟随的新区块在不同的历史链上可能不一样，但是就这个区块来说，这个区块被所有节点都认为是有效的可能性会越来越高。到一定的程度之后，我们就可以认为这是一个不可修改的区块。这也是我们经常听到当区块达到一定高度，我们就信任这笔交易的原因。
### 区块生成时间
区块生成时间是指区块链系统中生成一个新的区块所需的平均时间。当一个区块生成时间走完，最新的区块进入可验证的状态。区块生成时间越短，交易完成的速度也会越快。但是由于区块的生成涉及数据打包以及处理软分叉的打分系统，这都需要一定的时间开销。而不同的打分系统会有不同的时间开销，同时如果对安全性、稳定性各方面的要求越高，那么生成一个区块的时间自然也会越慢。所以区块生成时间在不同的区块链中的差别会非常大。比如以太坊的区块生成时间是 12 秒，而比特币是 10 分钟。

## 区块链的硬分叉

区块链就和传统的程序一样，随着时间的推移，软件的设计本身也会发生改变，甚至是在软件中出现严重的漏洞，如果在传统软件中就会产生升级的操作。而升级后是否向下兼容就会对整个软件造成完全不同的影响。区块链也是一样，区块的数据格式、生成区块的算法以及对区块链进行打分的算法都可能会升级。如果这种升级向下不兼容，就会出现两套算法在同时运行的情况。运行旧软件的计算机节点会继续用旧的协议来继续构建区块，而运行新软件的节点就会用新的协议去构建新的区块。通常升级会从某一个固定的区块开始，所以从这个固定的区块开始，就会分叉出两条完全不同的链。两者再也没有互相融合的可能。这就是区块链的硬分叉。
和传统软件升级不一样的是，硬分叉的代价很大，因为节点是否升级所牵扯的面很广，其中除了技术的原因，还有很多利益纠葛，比如有的节点的硬件就是专门为旧的协议设计，无法很好地适配新的协议，那么这些节点升级新协议的可能性就很小，甚至这种升级根本就不可能实现。更进一步，不同的人对区块链的想法不一样，不同的工作组有可能给出完全不同的升级协议，而这些协议都可能被一定数量的节点所接受，结果就是同一个区块链随着时间的推移，可能会发生很多次硬分叉。例如，比特币就被分叉过很多次，在交易市场上，很多和比特币的名字很类似的币，其实就是硬分叉导致的。以太坊也在某一次DAO黑客事件后进行回滚，有的节点不接受这次回滚，结果就是分叉出以太坊和经典以太坊两条链。
要解决硬分叉问题，在技术上并没有什么好的办法。不过随着时间的推移，不同的链在进行公平的竞争，最终总会有一些更好的被留下来，其他一些则被慢慢淘汰。所以，硬分叉到底是不是一个严重的问题，更多的就要看观察角度了。

## 区块链的去中心化

区块链数据库本质上存储在区块链所有的计算机节点上，这是一种经典的点对点网络系统，也就是去中心化的由来。通过去中心化，区块链避免了很多中心化系统的风险。
传统的中心化系统中，如果由于人为的攻击或者其他不可抗力的原因，导致服务器发生了故障，那么整个系统也就彻底瘫痪。在去中心化的区块链系统中，我们可以认为每一个节点都是一个功能完备的系统，除非整个区块链网络中的大部分节点都发生故障，不然区块链始终能正常运行，从这个角度看，去中心化的区块链系统很好地避免了单点故障。
由于每一个区块链节点都存储有一份区块链数据的备份，没有一个所谓权威的数据备份，这也就意味着从数据的角度来看，每一个节点的地位都是对等的，大家不用特别信任某一个节点。每个节点做的事情都一样，接受别的节点的数据，比较本地数据，生成新的数据，然后广播出去。区块链的各种算法会协调这些步骤，最终不断地记录合法的数据，如果系统中有恶意节点，随着时间的推移，由于它们的数据在评分系统中会越来越低，所以它们产生的恶意数据会自动被清除出去。
但是现实通常会更微妙，随着区块链系统的发展，很可能会伴随着去中心化的削弱。因为区块链系统的运行需要一定的计算资源，而这个资源有可能会越来越大，以至于普通的节点无法负担，那么大型资源节点最终就会占据越来越大的优势，最终区块链系统可能会被有限的大型资源节点接管。在比特币的发展中，我们就能看到大型矿池的出现。




## 51% 算力攻击

工作量证明并非无懈可击，工作量证明中，矿工解数学难题比拼的是算力，谁有更大的算力（运算的更快），就有更大的几率挖出区块，当一个节点的算力占全网算力的51%以上时，将获得记账权的绝对优势，可以更快地生成区块，某种程度上拥有了修改区块链数据的权利，从而对链发起攻击，最典型是双花攻击。

双花攻击通常是这样的：

攻击者在实施攻击前，会进行隐身挖矿（如下图橙色链），出块不进行广播，由于攻击者拥有更多能力，他在橙色链上挖矿的速度更快。
攻击者矿工在橙色链上修改他自己的交易，当橙色链比主链更长了，攻击者矿工便会立即向全网广播这条橙色链，而其他的矿工发现了这条橙色链后，按照协议，他们必须丢掉原本的主链，替换成这条橙色链，就完成了一次双花攻击。

![](https://img.learnblockchain.cn/2019/10/15724201974179.jpg)


当然，要实现对比特币双花攻击是非常困难的，攻击者除了花费巨额资金在挖矿硬件上，还需要大量的电力进行支撑，随着比特币网络算力越来越大，这种攻击可能性也就越来越小。
攻击者可能还需要承担更多的后果，例如，担被抓和被起诉的风险，币价下跌，还需要掩盖痕迹，洗钱等，权衡成本和风险，诚实挖矿往往收益大的多。






与传统方案不同的是，区块链的交易记录存储在很多不同的计算机上。而任意一个参与记录的计算机都很难修改交易记录，如果想要修改某一条交易信息，那就需要修改之后的所有交易信息。正所谓“牵一发而动全身”，任何微小的修改都会扩散到区块链的所有后续记录上，而这在实际操作中几乎不可能实现。这样的结果就是，所有参与的计算机都可以独立地验证交易或者发起交易，同时这样做的成本还很低。因此，区块链不需要任何独立机构单独维护，却具备不可篡改的特性。正是这种特性，让区块链具备了巨大的潜力。
我们通常把区块链存储交易记录的部分称为“区块链数据库”。区块链数据库和传统数据库也有着巨大的差别，它是存储于点对点的分布式网络之中，和 BT下载等分布式下载技术有相似之处。这也意味着没有任何一家机构拥有区块链数据库，相反，是参与到网络中的所有计算机共同拥有数据。
区块链中存储的信息非常简单，主要就是表示从一个地址到另一个地址的转账信息。而转账的内容被标注为不可重复，这也就意味着，和传统银行账户一样，当你发起转账之后，转账物的拥有权就发生了永久性的转移。但由于区块链本质上是一堆二进制数据，所以转账的数据并不局限在金钱的范畴。比如你完全可以把对某个网站的操作权限进行转移，当转移过后，操作权限就和新的交易地址唯一绑定，而旧的交易地址也就失去了权限。从这个角度出发，我们可以认为区块链其实是一个价值交换网络。任何有价值的东西都可以通过区块链来完成拥有权的转移。